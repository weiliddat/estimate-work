{{ define "main" }}
  <section>
    {{ block "room-name" . }}
      <h3 id="room-name" style="display: inline;" hx-swap-oob="true">
        Room:
        {{ if .Room.Name }}
          {{ .Room.Name }}
        {{ else }}
          {{ .Room.Id }}
        {{ end }}
      </h3>
    {{ end }}
    <a
      style="cursor: pointer; display: inline-block;"
      onclick="navigator.clipboard.writeText(window.location)"
    >
      <small>Copy room link</small>
    </a>
  </section>

  {{ if eq .Room.Host.Id .User.Id }}
    <section>
      <details id="room-controls-open">
        <summary>Manage room</summary>
        {{ block "room-controls" . }}
          <form
            id="room-controls"
            action="/room/{{ .Room.Id }}"
            method="post"
            hx-post="/room/{{ .Room.Id }}"
            hx-swap="none"
            hx-sync="#updater:replace"
            hx-swap-oob="true"
          >
            <fieldset role="group">
              <input
                type="text"
                name="name"
                placeholder="Update room name"
                value=""
              />
              <input type="submit" value="Submit" />
            </fieldset>

            <fieldset role="group">
              <input
                type="text"
                name="topic"
                placeholder="Update topic"
                value=""
              />
              <input type="submit" value="Submit" />
            </fieldset>

            <fieldset role="group">
              <input
                type="text"
                name="options"
                placeholder="Estimation options"
                value="{{ join .Room.Options "," }}"
              />
              <input type="submit" value="Submit" />
            </fieldset>

            <button type="submit" name="kick" value="true" class="outline secondary">
              Kick all users
            </button>

            {{ if not .Room.Revealed }}
              <button type="submit" name="reveal" value="true">
                Reveal estimates
              </button>
            {{ else }}
              <button
                type="submit"
                name="reveal"
                value="false"
                class="secondary"
              >
                Hide estimates
              </button>
            {{ end }}
          </form>
        {{ end }}
      </details>
    </section>
  {{ end }}

  {{ block "topic" . }}
    <hgroup id="topic" hx-swap-oob="true">
      <h3>Topic: {{ .Room.Topic }}</h3>
      {{ if .Room.Revealed }}
        <p>Estimates are revealed üêµ</p>
      {{ else }}
        <p>Estimates are hidden üôà</p>
      {{ end }}
    </hgroup>
  {{ end }}

  {{ block "options" . }}
    <section id="options" hx-swap-oob="true">
      <form
        action="/room/{{ .Room.Id }}"
        method="post"
        hx-post="/room/{{ .Room.Id }}"
        hx-swap="none"
        hx-sync="#updater:replace"
        class="grid"
      >
        {{ range .Room.Options }}
          <input
            type="submit"
            name="estimate"
            value="{{ . }}"
            class="{{ if ne . (index $.Room.Estimates $.User.Id) }}
              outline
            {{ end }}"
          />
        {{ end }}
      </form>
    </section>
  {{ end }}

  {{ block "participants" . }}
    <section id="participants" hx-swap-oob="true">
      <h3>Participants:</h3>
      <div class="grid">
        <h4>{{ .Room.Host.Name }} (Host)</h4>
        <h4>
          {{ $estimate := index $.Room.Estimates $.Room.Host.Id }}
          {{ if $estimate }}
            {{ if or $.Room.Revealed (eq $.Room.Host.Id $.User.Id) }}
              {{ $estimate }}
            {{ else }}
              ?
            {{ end }}
          {{ end }}
        </h4>
      </div>
      {{ range .Room.Users }}
        <div class="grid">
          <h4>{{ .Name }}</h4>
          <h4>
            {{ $estimate := index $.Room.Estimates .Id }}
            {{ if $estimate }}
              {{ if or $.Room.Revealed (eq .Id $.User.Id) }}
                {{ $estimate }}
              {{ else }}
                ?
              {{ end }}
            {{ end }}
          </h4>
        </div>
      {{ end }}
    </section>
  {{ end }}


  <div
    id="updater"
    hx-get="/room/{{ .Room.Id }}/update"
    hx-trigger="every 2s"
    hx-swap="none"
    hx-sync="this:abort"
  ></div>
{{ end }}

{{ define "updates-only" }}
  {{ template "room-name" . }}
  {{ template "participants" . }}
  {{ template "topic" . }}
  {{ template "options" . }}
  {{ if eq .Room.Host.Id .User.Id }}
    {{ template "room-controls" . }}
  {{ end }}
{{ end }}
