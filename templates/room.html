{{ define "main" }}
  <section>
    {{ block "room-name" . }}
      <h3 id="room-name" style="display: inline;" hx-swap-oob="true">
        Room:
        {{ .Room.DisplayName }}
      </h3>
    {{ end }}
    <a
      style="cursor: pointer; display: inline-block;"
      onclick="navigator.clipboard.writeText(window.location)"
    >
      <small>Copy room link</small>
    </a>
  </section>

  {{ if not .User }}
    <section>
      <form action="/room/{{ .Room.Id }}" method="post">
        <label>
          Your name
          <fieldset role="group">
            <input type="text" name="user-name" value="" />
            <input type="submit" value="Join Room" />
          </fieldset>
        </label>
      </form>
    </section>
  {{ else }}
    <section>
      <details id="room-controls-open">
        <summary>Manage room</summary>
        {{ block "room-controls" . }}
          <form
            id="room-controls"
            action="/room/{{ .Room.Id }}"
            method="post"
            hx-post="/room/{{ .Room.Id }}"
            hx-swap="none"
            hx-sync="#updater:replace"
            hx-swap-oob="true"
          >
            <label>
              Your name
              <fieldset role="group">
                <input type="text" name="user-name" value="{{ .User.Name }}" />
                <input type="submit" value="Submit" />
              </fieldset>
            </label>

            {{ if eq .Room.HostId .User.Id }}
              <label>
                Room name
                <fieldset role="group">
                  <input type="text" name="name" value="{{ .Room.Name }}" />
                  <input type="submit" value="Submit" />
                </fieldset>
              </label>

              <label>
                Current topic
                <fieldset role="group">
                  <input type="text" name="topic" value="{{ .Room.Topic }}" />
                  <input type="submit" value="Submit" />
                </fieldset>
              </label>

              <label>
                Estimation options
                <fieldset role="group">
                  <input
                    type="text"
                    name="options"
                    value="{{ join .Room.Options "," }}"
                  />
                  <input type="submit" value="Submit" />
                </fieldset>
              </label>

              <button
                type="submit"
                name="kick"
                value="true"
                class="outline secondary"
              >
                Kick all users
              </button>
            {{ end }}
          </form>
        {{ end }}
      </details>
    </section>

    {{ block "topic" . }}
      <hgroup id="topic" hx-swap-oob="true">
        <h3>Topic: {{ .Room.Topic }}</h3>
        {{ if .Room.Revealed }}
          <p>Estimates are revealed üêµ</p>
        {{ else }}
          <p>Estimates are hidden üôà</p>
        {{ end }}
      </hgroup>
    {{ end }}

    {{ block "options" . }}
      <section id="options" hx-swap-oob="true">
        <form
          action="/room/{{ .Room.Id }}"
          method="post"
          hx-post="/room/{{ .Room.Id }}"
          hx-swap="none"
          hx-sync="#updater:replace"
          class="grid"
        >
          {{ range .Room.Options }}
            <input
              type="submit"
              name="estimate"
              value="{{ . }}"
              class="{{ if ne . (index $.Room.Estimates $.User.Id) }}
                outline
              {{ end }}"
            />
          {{ end }}
        </form>

        {{ if eq .Room.HostId .User.Id }}
          <form
            action="/room/{{ .Room.Id }}"
            method="post"
            hx-post="/room/{{ .Room.Id }}"
            hx-swap="none"
            hx-sync="#updater:replace"
          >
            {{ if not .Room.Revealed }}
              <button type="submit" name="reveal" value="true">
                Reveal estimates
              </button>
            {{ else }}
              <button
                type="submit"
                name="reveal"
                value="false"
                class="secondary"
              >
                Hide estimates
              </button>
            {{ end }}
          </form>
        {{ end }}
      </section>
    {{ end }}

    {{ block "participants" . }}
      <section id="participants" hx-swap-oob="true">
        <h3>Participants:</h3>
        {{ range .Room.Users }}
          <div class="grid">
            <h4>
              {{ .Name }}
              {{ if eq .Id $.Room.HostId }}
                <span title="Host">üëë</span>
              {{ end }}
              {{ if eq .Id $.User.Id }}
                <span title="You">ü´µ</span>
              {{ end }}
            </h4>
            <h4>
              {{ $estimate := index $.Room.Estimates .Id }}
              {{ if $estimate }}
                {{ if or $.Room.Revealed (eq .Id $.User.Id) }}
                  {{ $estimate }}
                {{ else }}
                  ?
                {{ end }}
              {{ end }}
            </h4>
          </div>
        {{ end }}
      </section>
    {{ end }}


    <div
      id="updater"
      hx-get="/room/{{ .Room.Id }}/update"
      hx-trigger="every 1s"
      hx-swap="none"
      hx-sync="this:abort"
    ></div>
  {{ end }}
{{ end }}

{{ define "updates-only" }}
  {{ template "room-name" . }}
  {{ template "participants" . }}
  {{ template "topic" . }}
  {{ template "options" . }}
{{ end }}
